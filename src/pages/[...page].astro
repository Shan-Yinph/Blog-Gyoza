---
import type { GetStaticPaths } from 'astro'
import PageLayout from '@/layouts/PageLayout.astro'
import PostList from '@/components/post/PostList.astro'
import PostPagination from '@/components/post/PostPagination.astro'
import { getSortedPosts, getHotTags, getAllCategories, getAllTags } from '@/utils/content'
import appConfig from '@/config.json'
import SectionBlock from '@/components/SectionBlock.astro'
import TagList from '@/components/TagList.astro'
import CategoryList from '@/components/CategoryList.astro'
import type { CollectionEntry } from 'astro:content'
import Hero from '@/components/hero/Hero.astro'

export const getStaticPaths = (async () => {
  const sortedPosts = await getSortedPosts()
  const { perPage } = appConfig.posts
  const totalPage = Math.ceil(sortedPosts.length / perPage)

  // 分离置顶和非置顶文章
  const stickyPosts = sortedPosts.filter(post => post.data.sticky > 0)
  // 非置顶文章已经按日期降序排序，只取最新的一篇
  const latestNonStickyPosts = sortedPosts.filter(post => post.data.sticky === 0).slice(0, 1)

  const paths = Array.from({ length: totalPage }).map((_, i) => {
    let data;
    if (i === 0) {
      // 首页显示所有置顶文章和最新的一篇非置顶文章
      data = [...stickyPosts, ...latestNonStickyPosts]
    } else {
      // 其他页面按原来的分页逻辑
      data = sortedPosts.slice(i * perPage, (i + 1) * perPage)
    }
    const props = { currentPage: i + 1, totalPage, data }
    const params = {
      page: i === 0 ? undefined : `page/${i + 1}`,
    }
    return { params, props }
  })

  return paths
}) satisfies GetStaticPaths

interface Props {
  currentPage: number
  totalPage: number
  data: CollectionEntry<'posts'>[]
}

const { currentPage, totalPage, data } = Astro.props

// 首页数据已经在getStaticPaths中处理过
const displayData = data;

const hotTags = await getHotTags()
const allTags = await getAllTags()
const allCategories = await getAllCategories()

const getPageUrl = (page: number) => {
  if (page === 1) return '/'
  return `/page/${page}`
}
---

<PageLayout>
  <div>
    {currentPage === 1 && <Hero />}
    <div class="max-w-[1100px] px-4 md:px-8 py-20 mx-auto grid lg:grid-cols-[auto_300px] gap-10">
      <div class="min-w-0">
        <SectionBlock title="最新动态">
          <PostList posts={displayData} />
          {
            totalPage > 1 && (
              <PostPagination current={currentPage} total={totalPage} getPageUrl={getPageUrl} />
            )
          }
        </SectionBlock>
      </div>
      <div>
        <aside class="md:sticky md:top-20 space-y-10">
          <SectionBlock title="分类">
            <CategoryList categories={allCategories} />
          </SectionBlock>
          <SectionBlock title="热门标签">
            <TagList tags={hotTags} />
            {
              allTags.length > hotTags.length && (
                <div class="mt-2 text-right">
                  <a class="text-sm text-secondary hover:text-accent" href="/tags">
                    更多标签 <i class="iconfont icon-arrow-right" />
                  </a>
                </div>
              )
            }
          </SectionBlock>
        </aside>
      </div>
    </div>
  </div>
</PageLayout>
